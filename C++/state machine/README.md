# ATM说明
---
:art:
---
* state machine
  * 将每个线程看作一个状态机,当它收到一个消息时,更新自己的状态并发送一个或多个消息给其它线程,其实现依赖于初始状态;
  * 各线程依靠消息队列进行通信;
* ATM
  * 功能
    * 处理人与ATM机间的交互
      * 接收卡片;
      * 显示消息;
      * 处理按键;
      * 放出现金;
      * 退回卡片;
    * ATM机与银行间的交互;
  * 处理方案(分为三个线程)
    * 一个线程处理ATM物理机;
    * 一个线程处理ATM逻辑业务;
    * 一个与银行进行通信;
  * ATM业务逻辑状态机
    * 在每个状态,ATM线程都在等待一个特定的信息,然后处理它,并转换到合适的状态;
    * 大致状态图

      ![ATM state](https://github.com/Chorior/commonCodes/blob/master/C%2B%2B/state%20machine/ATM.png)

    * 说明
      * 状态0(等待插入卡片)
        * 初始状态;
        * 若卡片插入,进入状态1;
      * 状态1(等待输入密码)
        * 若按下cancel,进入状态6;
        * 一次输入一个数字,一旦密码位数足够,进入状态2;
        * 可以删除输入的最后一个数字;
      * 状态2(确认密码是否正确)
        * 若按下cancel,进入状态6;
        * 若密码错误,进入黄台6;
        * 若密码正确,进入状态3;
      * 状态3(等待用户操作)
        * 若按下cancel,进入状态6;
        * 若按下余额按钮,向银行发送获取余额信息,进入状态4;
        * 若按下取款按钮,向银行发送取款信息,进入状态5;
      * 状态4(显示余额)
        * 若按下cancel,进入状态6;
        * 向ATM物理机发送显示余额信息,进入状态3;
      * 状态5(放款处理)
        * 若按下cancel,进入状态6;
        * 若余额充足,放出现金,进入状态6;
        * 若余额不足,向ATM物理机发送显示余额不足,进入状态6;
      * 状态6(退回卡片)
        * 向ATM物理机发送退卡信息,返回初始状态;

    * 主函数(state是一个函数指针)

      ```C++
      void run()
      {
        state=&atm::waiting_for_card;
        try
        {
          for(;;)
          {
            (this->*state)();
          }
        }
        catch(messaging::close_queue const&)
        {}
      }
      ```

  * 银行状态机
  * 用户界面状态机
